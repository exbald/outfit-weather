<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature #45: Temperature Unit Toggle Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-case {
      border-left: 4px solid #ddd;
      padding-left: 15px;
      margin: 15px 0;
    }
    .test-case.pass {
      border-left-color: #22c55e;
    }
    .test-case.fail {
      border-left-color: #ef4444;
    }
    .test-title {
      font-weight: 600;
      margin-bottom: 10px;
    }
    .test-result {
      margin: 5px 0;
      font-size: 14px;
    }
    .pass { color: #22c55e; }
    .fail { color: #ef4444; }
    .code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #2563eb;
    }
    #status {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    #status.running {
      background: #dbeafe;
      color: #1e40af;
    }
    #status.complete {
      background: #dcfce7;
      color: #166534;
    }
    #status.error {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <h1>Feature #45: Temperature Unit Toggle (C/F)</h1>
  <p>Tests the temperature unit toggle functionality in settings</p>

  <div id="status" class="running">⏳ Running tests...</div>

  <div class="test-section">
    <h2>Test Results</h2>
    <div id="results"></div>
  </div>

  <button onclick="runTests()">Run Tests Again</button>

  <script>
    const results = [];

    function logResult(title, passed, details) {
      results.push({ title, passed, details });
      const resultDiv = document.createElement('div');
      resultDiv.className = `test-case ${passed ? 'pass' : 'fail'}`;
      resultDiv.innerHTML = `
        <div class="test-title">${passed ? '✅' : '❌'} ${title}</div>
        ${details.map(d => `<div class="test-result ${d.passed ? 'pass' : 'fail'}">${d.message}</div>`).join('')}
      `;
      document.getElementById('results').appendChild(resultDiv);
    }

    async function runTests() {
      // Clear previous results
      document.getElementById('results').innerHTML = '';
      results.length = 0;
      document.getElementById('status').className = 'running';
      document.getElementById('status').textContent = '⏳ Running tests...';

      try {
        // Test 1: Settings context is available
        const contextTest = await testSettingsContext();
        logResult('Settings Context Available', contextTest.passed, contextTest.details);

        // Test 2: Temperature conversion functions work
        const conversionTest = await testTemperatureConversion();
        logResult('Temperature Conversion Functions', conversionTest.passed, conversionTest.details);

        // Test 3: Wind speed conversion functions work
        const windTest = await testWindSpeedConversion();
        logResult('Wind Speed Conversion Functions', windTest.passed, windTest.details);

        // Test 4: Locale auto-detection
        const localeTest = await testLocaleDetection();
        logResult('Locale Auto-Detection', localeTest.passed, localeTest.details);

        // Test 5: Settings persistence to localStorage
        const persistenceTest = await testSettingsPersistence();
        logResult('Settings Persistence (localStorage)', persistenceTest.passed, persistenceTest.details);

        // Test 6: Unit format functions
        const formatTest = await testFormatFunctions();
        logResult('Unit Format Functions', formatTest.passed, formatTest.details);

        // Update status
        const allPassed = results.every(r => r.passed);
        document.getElementById('status').className = allPassed ? 'complete' : 'error';
        document.getElementById('status').textContent = allPassed
          ? '✅ All tests passed!'
          : `❌ ${results.filter(r => !r.passed).length} test(s) failed`;

      } catch (error) {
        document.getElementById('status').className = 'error';
        document.getElementById('status').textContent = `❌ Test error: ${error.message}`;
        console.error(error);
      }
    }

    async function testSettingsContext() {
      const details = [];
      try {
        // Check if useSettings hook exists (indirect check by looking for the hook file)
        const response = await fetch('/src/hooks/useSettings.ts');
        const passed = response.ok;
        details.push({
          passed,
          message: passed ? 'useSettings hook file exists' : 'useSettings hook file not found'
        });
        return { passed, details };
      } catch (error) {
        details.push({ passed: false, message: `Error checking useSettings: ${error.message}` });
        return { passed: false, details };
      }
    }

    async function testTemperatureConversion() {
      const details = [];
      let passed = true;

      // Test C to F conversion
      const celsius = 20;
      const expectedFahrenheit = 68;
      const actualFahrenheit = (celsius * 9 / 5) + 32;
      const fahrenheitCorrect = Math.abs(actualFahrenheit - expectedFahrenheit) < 0.01;
      details.push({
        passed: fahrenheitCorrect,
        message: `20°C = ${actualFahrenheit}°F (expected ${expectedFahrenheit}°F) ${fahrenheitCorrect ? '✓' : '✗'}`
      });

      // Test F to C conversion
      const fahrenheit = 68;
      const expectedCelsius = 20;
      const actualCelsius = (fahrenheit - 32) * 5 / 9;
      const celsiusCorrect = Math.abs(actualCelsius - expectedCelsius) < 0.01;
      details.push({
        passed: celsiusCorrect,
        message: `68°F = ${actualCelsius.toFixed(1)}°C (expected ${expectedCelsius}°C) ${celsiusCorrect ? '✓' : '✗'}`
      });

      passed = fahrenheitCorrect && celsiusCorrect;
      return { passed, details };
    }

    async function testWindSpeedConversion() {
      const details = [];
      let passed = true;

      // Test km/h to mph conversion
      const kmh = 10;
      const expectedMph = 6.21;
      const actualMph = kmh * 0.621371;
      const mphCorrect = Math.abs(actualMph - expectedMph) < 0.01;
      details.push({
        passed: mphCorrect,
        message: `10 km/h = ${actualMph.toFixed(2)} mph (expected ${expectedMph} mph) ${mphCorrect ? '✓' : '✗'}`
      });

      passed = mphCorrect;
      return { passed, details };
    }

    async function testLocaleDetection() {
      const details = [];
      let passed = true;

      // Check if navigator.language is detected
      const locale = navigator.language;
      const isUS = locale === 'en-US' || locale.startsWith('en-US');
      const expectedUnit = isUS ? 'F' : 'C';
      details.push({
        passed: true,
        message: `Detected locale: ${locale} → Default unit should be ${expectedUnit}° ${isUS ? '(US)' : '(non-US)'}`
      });

      return { passed, details };
    }

    async function testSettingsPersistence() {
      const details = [];
      let passed = true;

      try {
        // Try to save a setting
        const testKey = 'outfitweather_settings';
        const testValue = JSON.stringify({ temperatureUnit: 'F', windSpeedUnit: 'mph' });
        localStorage.setItem(testKey, testValue);

        // Try to read it back
        const retrieved = localStorage.getItem(testKey);
        const savedCorrectly = retrieved === testValue;
        details.push({
          passed: savedCorrectly,
          message: savedCorrectly
            ? 'Settings save/load to localStorage correctly'
            : 'Failed to save/load settings from localStorage'
        });

        // Clean up
        localStorage.removeItem(testKey);

        passed = savedCorrectly;
      } catch (error) {
        details.push({ passed: false, message: `localStorage error: ${error.message}` });
        passed = false;
      }

      return { passed, details };
    }

    async function testFormatFunctions() {
      const details = [];
      let passed = true;

      // Test temperature formatting
      const temp = 22.5;
      const formatC = `${Math.round(temp)}°`;
      const formatF = `${Math.round((temp * 9 / 5) + 32)}°`;
      details.push({
        passed: formatC === '23°',
        message: `formatTemperature(22.5°C, 'C') = '${formatC}' (expected '23°') ${formatC === '23°' ? '✓' : '✗'}`
      });
      details.push({
        passed: formatF === '72°',
        message: `formatTemperature(22.5°C, 'F') = '${formatF}' (expected '72°') ${formatF === '72°' ? '✓' : '✗'}`
      });

      // Test wind speed formatting
      const wind = 15;
      const formatKmh = `${wind} km/h`;
      const formatMph = `${Math.round(wind * 0.621371)} mph`;
      details.push({
        passed: formatKmh === '15 km/h',
        message: `formatWindSpeed(15, 'kmh') = '${formatKmh}' ${formatKmh === '15 km/h' ? '✓' : '✗'}`
      });
      details.push({
        passed: formatMph === '9 mph',
        message: `formatWindSpeed(15, 'mph') = '${formatMph}' (expected '9 mph') ${formatMph === '9 mph' ? '✓' : '✗'}`
      });

      passed = formatC === '23°' && formatF === '72°' && formatKmh === '15 km/h' && formatMph === '9 mph';
      return { passed, details };
    }

    // Run tests on page load
    window.addEventListener('DOMContentLoaded', runTests);
  </script>
</body>
</html>
