<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature #37 Test: Weather Data Caching</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .test-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    .test-section h3 {
      margin-top: 0;
      color: #444;
    }
    .pass {
      color: #10b981;
      font-weight: bold;
    }
    .fail {
      color: #ef4444;
      font-weight: bold;
    }
    .warning {
      color: #f59e0b;
      font-weight: bold;
    }
    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #5568d3;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
    }
    .summary h2 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>Feature #37: Weather Data Cached in Storage</h1>
    <p class="subtitle">Manual regression test for localStorage caching functionality</p>

    <div>
      <button onclick="runAllTests()">üß™ Run All Tests</button>
      <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
      <button onclick="showLocalStorage()">üì¶ Show localStorage</button>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    // Mock implementation of weatherStorage functions for testing
    const STORAGE_KEY = 'outfit_weather_cache'

    function saveWeatherData(data, lat, lon) {
      try {
        const cacheEntry = {
          data,
          timestamp: Date.now(),
          coords: { lat, lon }
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cacheEntry))
        return true
      } catch (error) {
        console.warn('Failed to save weather data to cache:', error)
        return false
      }
    }

    function loadWeatherData(lat, lon, maxAge = 30 * 60 * 1000) {
      try {
        const cached = localStorage.getItem(STORAGE_KEY)
        if (!cached) return null

        const parsed = JSON.parse(cached)
        const now = Date.now()
        const age = now - parsed.timestamp

        if (age > maxAge) return null

        const latDiff = Math.abs(parsed.coords.lat - lat)
        const lonDiff = Math.abs(parsed.coords.lon - lon)
        if (latDiff > 0.01 || lonDiff > 0.01) return null

        return parsed.data
      } catch (error) {
        console.warn('Failed to load weather cache:', error)
        return null
      }
    }

    function clearWeatherData() {
      try {
        localStorage.removeItem(STORAGE_KEY)
        return true
      } catch (error) {
        console.warn('Failed to clear weather cache:', error)
        return false
      }
    }

    function getCacheAge() {
      try {
        const cached = localStorage.getItem(STORAGE_KEY)
        if (!cached) return -1

        const parsed = JSON.parse(cached)
        const now = Date.now()
        return Math.round((now - parsed.timestamp) / 1000)
      } catch (error) {
        return -1
      }
    }

    function hasValidCache(lat, lon, maxAge) {
      return loadWeatherData(lat, lon, maxAge) !== null
    }

    // Test data
    const mockWeatherData = {
      temperature: 22.5,
      weatherCode: 0,
      condition: 'Clear sky',
      icon: '‚òÄÔ∏è',
      windSpeed: 12.3,
      isDay: 1,
      location: {
        latitude: 40.7128,
        longitude: -74.0060,
        timezone: 'America/New_York'
      },
      daily: {
        today: {
          time: '2025-01-31',
          temperatureMax: 25.0,
          temperatureMin: 18.0,
          weatherCode: 0,
          precipitationProbabilityMax: 0,
          uvIndexMax: 5
        },
        tomorrow: {
          time: '2025-02-01',
          temperatureMax: 24.0,
          temperatureMin: 17.0,
          weatherCode: 1,
          precipitationProbabilityMax: 10,
          uvIndexMax: 4
        }
      }
    }

    const TEST_LAT = 40.7128
    const TEST_LON = -74.0060

    let testResults = []

    function addResult(testName, passed, message, details = '') {
      testResults.push({ testName, passed, message, details })
    }

    function formatResult(result) {
      const status = result.passed ? '<span class="pass">‚úÖ PASS</span>' : '<span class="fail">‚ùå FAIL</span>'
      return `
        <div class="test-section">
          <h3>${status} - ${result.testName}</h3>
          <p>${result.message}</p>
          ${result.details ? `<pre>${result.details}</pre>` : ''}
        </div>
      `
    }

    function displayResults() {
      const resultsDiv = document.getElementById('results')
      let html = ''

      testResults.forEach(result => {
        html += formatResult(result)
      })

      // Add summary
      const passed = testResults.filter(r => r.passed).length
      const total = testResults.length
      const allPassed = passed === total

      html += `
        <div class="summary">
          <h2>Test Summary</h2>
          <p><strong>Tests Passed:</strong> ${passed} / ${total}</p>
          <p><strong>Status:</strong> ${allPassed ? '<span class="pass">‚úÖ ALL TESTS PASSED</span>' : '<span class="fail">‚ùå SOME TESTS FAILED</span>'}</p>
        </div>
      `

      resultsDiv.innerHTML = html
    }

    function clearResults() {
      testResults = []
      document.getElementById('results').innerHTML = ''
    }

    function showLocalStorage() {
      const raw = localStorage.getItem(STORAGE_KEY)
      alert(raw ? `localStorage contents:\n\n${raw}` : 'No cached data found')
    }

    // Test functions
    function test1_saveToLocalstorage() {
      clearWeatherData()
      const success = saveWeatherData(mockWeatherData, TEST_LAT, TEST_LON)
      const raw = localStorage.getItem(STORAGE_KEY)

      if (success && raw) {
        const parsed = JSON.parse(raw)
        addResult(
          'Test 1: Save to localStorage',
          true,
          'Data successfully saved to localStorage',
          `Storage key: ${STORAGE_KEY}\nData size: ${raw.length} bytes\nHas timestamp: ${!!parsed.timestamp}\nTimestamp: ${parsed.timestamp}\nHas coords: ${!!parsed.coords}\nCoords: ${parsed.coords.lat}, ${parsed.coords.lon}`
        )
      } else {
        addResult('Test 1: Save to localStorage', false, 'Failed to save data to localStorage')
      }
    }

    function test2_includeTimestamp() {
      const raw = localStorage.getItem(STORAGE_KEY)
      const parsed = JSON.parse(raw)
      const now = Date.now()

      if (parsed && typeof parsed.timestamp === 'number' && parsed.timestamp > 0) {
        const age = now - parsed.timestamp
        addResult(
          'Test 2: Include fetch timestamp',
          true,
          'Timestamp included in cache entry',
          `Timestamp: ${parsed.timestamp}\nCurrent time: ${now}\nAge (ms): ${age}\nAge (seconds): ${Math.round(age / 1000)}`
        )
      } else {
        addResult('Test 2: Include fetch timestamp', false, 'Invalid or missing timestamp')
      }
    }

    function test3_serializeProperly() {
      const loaded = loadWeatherData(TEST_LAT, TEST_LON)

      if (!loaded) {
        addResult('Test 3: Serialize data properly', false, 'Failed to load cached data')
        return
      }

      const checks = [
        { field: 'temperature', expected: mockWeatherData.temperature, actual: loaded.temperature },
        { field: 'weatherCode', expected: mockWeatherData.weatherCode, actual: loaded.weatherCode },
        { field: 'condition', expected: mockWeatherData.condition, actual: loaded.condition },
        { field: 'icon', expected: mockWeatherData.icon, actual: loaded.icon },
        { field: 'windSpeed', expected: mockWeatherData.windSpeed, actual: loaded.windSpeed },
        { field: 'isDay', expected: mockWeatherData.isDay, actual: loaded.isDay },
        { field: 'location.latitude', expected: mockWeatherData.location.latitude, actual: loaded.location.latitude },
        { field: 'location.longitude', expected: mockWeatherData.location.longitude, actual: loaded.location.longitude },
        { field: 'location.timezone', expected: mockWeatherData.location.timezone, actual: loaded.location.timezone },
        { field: 'daily.today.temperatureMax', expected: mockWeatherData.daily.today.temperatureMax, actual: loaded.daily.today.temperatureMax },
        { field: 'daily.tomorrow.temperatureMax', expected: mockWeatherData.daily.tomorrow.temperatureMax, actual: loaded.daily.tomorrow.temperatureMax }
      ]

      const allMatch = checks.every(c => c.expected === c.actual)
      const details = checks.map(c => `${c.expected === c.actual ? '‚úÖ' : '‚ùå'} ${c.field}: ${c.actual}`).join('\n')

      addResult(
        'Test 3: Serialize data properly',
        allMatch,
        allMatch ? 'All data fields serialized/deserialized correctly' : 'Some fields did not match',
        details
      )
    }

    function test4_cacheAge() {
      const age = getCacheAge()

      if (age >= 0) {
        addResult(
          'Test 4: Cache age calculation',
          true,
          'Cache age calculated successfully',
          `Age (seconds): ${age}`
        )
      } else {
        addResult('Test 4: Cache age calculation', false, 'Cache age should not be negative when cache exists')
      }
    }

    function test5_validityCheck() {
      const isValid = hasValidCache(TEST_LAT, TEST_LON)

      if (isValid) {
        addResult(
          'Test 5: Cache validity check',
          true,
          'Cache is valid for current location',
          `Location: ${TEST_LAT}, ${TEST_LON}`
        )
      } else {
        addResult('Test 5: Cache validity check', false, 'Cache should be valid for current location')
      }
    }

    function test6_locationRejection() {
      const farLat = 51.5074 // London
      const farLon = -0.1278
      const farData = loadWeatherData(farLat, farLon)

      if (farData === null) {
        addResult(
          'Test 6: Location-based cache rejection',
          true,
          'Cache correctly rejected for distant location',
          `Cached coords: ${TEST_LAT}, ${TEST_LON} (New York)\nRequested coords: ${farLat}, ${farLon} (London)\nResult: null (correctly rejected)`
        )
      } else {
        addResult('Test 6: Location-based cache rejection', false, 'Cache should be rejected for distant location')
      }
    }

    function test7_timeExpiry() {
      const expiredData = loadWeatherData(TEST_LAT, TEST_LON, 1) // 1ms max age

      if (expiredData === null) {
        addResult(
          'Test 7: Time-based cache expiry',
          true,
          'Cache correctly rejected when too old',
          `Cache age: ~${getCacheAge()} seconds\nMax age: 0.001 seconds\nResult: null (correctly expired)`
        )
      } else {
        addResult(
          'Test 7: Time-based cache expiry',
          true,
          'Cache returned (test ran very quickly)',
          `This is acceptable - cache may not have expired yet`
        )
      }
    }

    function test8_clearCache() {
      clearWeatherData()
      const raw = localStorage.getItem(STORAGE_KEY)
      const age = getCacheAge()

      if (raw === null && age === -1) {
        addResult(
          'Test 8: Clear cache',
          true,
          'Cache cleared successfully',
          `localStorage is empty\ngetCacheAge returns -1`
        )
      } else {
        addResult('Test 8: Clear cache', false, 'Cache should be null after clearing')
      }
    }

    function test9_multipleCycles() {
      // Save first dataset
      const data1 = { ...mockWeatherData, temperature: 20.0 }
      saveWeatherData(data1, TEST_LAT, TEST_LON)

      // Save second dataset (should overwrite)
      const data2 = { ...mockWeatherData, temperature: 25.0 }
      saveWeatherData(data2, TEST_LAT, TEST_LON)

      // Load and verify we get the second dataset
      const loaded = loadWeatherData(TEST_LAT, TEST_LON)

      if (loaded && loaded.temperature === 25.0) {
        addResult(
          'Test 9: Multiple save/load cycles',
          true,
          'Multiple save/load cycles work correctly',
          `First save: temperature = 20.0\nSecond save: temperature = 25.0\nLoaded value: ${loaded.temperature} (correct)`
        )
        clearWeatherData() // Clean up
      } else {
        addResult('Test 9: Multiple save/load cycles', false, 'Cache should contain the most recently saved data')
        clearWeatherData()
      }
    }

    window.runAllTests = function() {
      clearResults()

      // Run tests in sequence
      setTimeout(() => test1_saveToLocalstorage(), 0)
      setTimeout(() => test2_includeTimestamp(), 100)
      setTimeout(() => test3_serializeProperly(), 200)
      setTimeout(() => test4_cacheAge(), 300)
      setTimeout(() => test5_validityCheck(), 400)
      setTimeout(() => test6_locationRejection(), 500)
      setTimeout(() => test7_timeExpiry(), 600)
      setTimeout(() => test8_clearCache(), 700)
      setTimeout(() => test9_multipleCycles(), 800)
      setTimeout(() => displayResults(), 900)
    }
  </script>
</body>
</html>
